{# HTMX partial response - returns only the dynamic content portions #}
{% set theme_config = config.themes.helios %}
{% set nav_config = theme_config.navigation %}

{# Breadcrumbs #}
<div id="htmx-breadcrumbs">
    {% if nav_config.breadcrumbs and helios_breadcrumbs is defined and helios_breadcrumbs|length > 1 %}
        {% include 'partials/breadcrumbs.html.twig' %}
    {% endif %}
</div>

{# Main article content - template-aware rendering #}
<article id="htmx-article" class="prose dark:prose-invert max-w-none">
    {% if page.template == 'chapter' %}
        {# Chapter template content #}
        <div class="not-prose mb-8">
            <h1 class="flex items-center gap-4 mb-4 text-3xl font-bold tracking-tight text-gray-900 dark:text-white">
                {% if page.header.icon %}
                <span class="flex-shrink-0 inline-flex items-center justify-center p-2 rounded-xl bg-primary/15 text-primary">
                    {{ svg_icon(page.header.icon, 'w-6 h-6')|raw }}
                </span>
                {% endif %}
                <span>{{ page.title }}</span>
            </h1>

            {% if page.header.description or page.summary %}
            <p class="text-lg text-gray-600 dark:text-gray-400">
                {{ page.header.description ?: page.summary|striptags }}
            </p>
            {% endif %}
        </div>

        {% if page.content|trim %}
            <div class="mb-12">
                {{ page.content|raw }}
            </div>
        {% endif %}

        {# Child pages listing #}
        {% set children = page.children.visible %}
        {% if children.count > 0 %}
        <div class="grid gap-4 sm:grid-cols-2">
            {% for child in children %}
            <a href="{{ child.url }}"
               class="hover:!no-underline group block p-6 rounded-lg border border-gray-200 dark:border-gray-700 hover:border-primary dark:hover:border-primary transition-colors">
                <h3 class="flex items-center gap-3 text-base font-semibold text-gray-900 dark:text-white group-hover:text-primary transition-colors">
                    {% if child.header.icon %}
                    <span class="flex-shrink-0 inline-flex items-center justify-center p-2 rounded-xl bg-primary/15 text-primary">
                        {{ svg_icon(child.header.icon, 'w-5 h-5')|raw }}
                    </span>
                    {% endif %}
                    <span>{{ child.title }}</span>
                </h3>
                {% if child.header.description or child.summary %}
                <p class="mt-3 text-sm text-gray-600 dark:text-gray-400 line-clamp-2">
                    {{ child.header.description ?: child.summary|striptags }}
                </p>
                {% endif %}
            </a>
            {% endfor %}
        </div>
        {% endif %}
    {% elseif page.template == 'api-endpoint' %}
        {# API Endpoint template content #}
        {% set api = page.header.api %}
        <h1>{{ page.title }}</h1>

        {% if api %}
        <div class="api-endpoint-card not-prose">
            <div class="endpoint-header">
                <span class="api-method method-{{ api.method|lower }}">{{ api.method }}</span>
                <code class="endpoint-path">
                    {{ theme_config.api.base_url }}{% for part in api.path|split('/') %}{% if part starts with '{' %}<span class="path-param">{{ part }}</span>{% else %}{{ part }}{% endif %}{% if not loop.last %}/{% endif %}{% endfor %}
                </code>
            </div>

            {% if api.description %}
            <div class="endpoint-description">
                {{ api.description|raw }}
            </div>
            {% endif %}

            <div class="endpoint-body">
                {% if api.parameters %}
                <div class="api-params">
                    <h3 class="params-title">{{ 'THEME_HELIOS.PARAMETERS'|t }}</h3>
                    <table class="params-table">
                        <thead>
                            <tr>
                                <th>{{ 'THEME_HELIOS.NAME'|t }}</th>
                                <th>{{ 'THEME_HELIOS.TYPE'|t }}</th>
                                <th>{{ 'THEME_HELIOS.DESCRIPTION'|t }}</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for param in api.parameters %}
                            <tr>
                                <td>
                                    <span class="param-name">{{ param.name }}</span>
                                    {% if param.required %}
                                    <span class="param-required">{{ 'THEME_HELIOS.REQUIRED'|t }}</span>
                                    {% else %}
                                    <span class="param-optional">{{ 'THEME_HELIOS.OPTIONAL'|t }}</span>
                                    {% endif %}
                                </td>
                                <td><span class="param-type">{{ param.type }}</span></td>
                                <td>
                                    <span class="param-description">{{ param.description }}</span>
                                    {% if param.default is defined %}
                                    <div class="param-default">{{ 'THEME_HELIOS.DEFAULT'|t }} <code>{{ param.default }}</code></div>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% endif %}

                {% if api.request_example or api.response_example %}
                {% set default_tab = api.request_example ? 'request' : 'response' %}
                <div class="api-examples" x-data="{ tab: '{{ default_tab }}' }">
                    <div class="examples-tabs">
                        {% if api.request_example %}
                        <button @click="tab = 'request'" :class="{ 'active': tab === 'request' }">{{ 'THEME_HELIOS.REQUEST'|t }}</button>
                        {% endif %}
                        {% if api.response_example %}
                        <button @click="tab = 'response'" :class="{ 'active': tab === 'response' }">{{ 'THEME_HELIOS.RESPONSE'|t }}</button>
                        {% endif %}
                    </div>
                    {% if api.request_example %}
                    <div x-show="tab === 'request'" class="example-panel" :class="{ 'active': tab === 'request' }">
                        {{ api.request_example|codesh('json') }}
                    </div>
                    {% endif %}
                    {% if api.response_example %}
                    <div x-show="tab === 'response'" class="example-panel" :class="{ 'active': tab === 'response' }">
                        {{ api.response_example|codesh('json') }}
                    </div>
                    {% endif %}
                </div>
                {% endif %}

                {% if api.response_codes %}
                <div class="api-responses">
                    <h3 class="responses-title">{{ 'THEME_HELIOS.RESPONSE_CODES'|t }}</h3>
                    {% for response in api.response_codes %}
                    <div class="response-item">
                        <span class="response-code code-{{ response.code|slice(0, 1) }}xx">{{ response.code }}</span>
                        <span class="response-description">{{ response.description }}</span>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}

        {{ page.content|raw }}
    {% else %}
        {# Default template content #}
        {{ page.content|raw }}
    {% endif %}
</article>

{# Previous/Next navigation #}
<div id="htmx-prev-next">
    {% if nav_config.prev_next %}
        {% include 'partials/prev-next.html.twig' %}
    {% endif %}
</div>

{# TOC content for client-side update #}
<template id="htmx-toc-template">
    {% include 'partials/toc.html.twig' %}
</template>

{# Navigation state for client-side active state updates #}
<script type="application/json" id="htmx-nav-state">
{
    "route": "{{ page.route }}",
    "url": "{{ page.url }}",
    "title": "{{ page.title|e('js') }}",
    "siteTitle": "{{ site.title|e('js') }}",
    "appendSiteTitle": {{ (theme_config.append_site_title ?? true) ? 'true' : 'false' }}
}
</script>
